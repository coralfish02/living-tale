# Living Tale — 育てる。生まれる。ストーリー。

![Living Tale](https://img.shields.io/badge/Living_Tale-Gardening_Storytelling-gold)
![Google Cloud](https://img.shields.io/badge/Google%20Cloud-Vertex%20AI-4285F4)
![Gemini](https://img.shields.io/badge/Gemini_2.0_Flash-Multi_Agent-8E44AD)
![Imagen](https://img.shields.io/badge/Imagen_3-Image_Generation-E74C3C)
![Status](https://img.shields.io/badge/Status-Live-success)

> **第4回 Agentic AI Hackathon with Google Cloud** 参加作品 — チーム Echo

## 🌐 デモ

**公開URL**: https://project-echo-192671776924.us-central1.run.app

テーマを1行入力するだけで、AIキャラクターが自律的に会話し、起承転結のある物語が生成されます。

![Living Tale メイン画面](images/living-tale-ui.png)

---

## 📖 プロダクト概要

Living Taleは、**「書く（Write）」のではなく、環境を与えて「育てる（Grow）」**という新しい創作体験を提供するAIエージェントシステムです。

### 解決する課題

| 対象 | 課題（Pain） |
|---|---|
| **プロの漫画家・脚本家** | キャラクターのシミュレーションに膨大な時間がかかる / 予定調和に陥りやすい |
| **一般のクリエイター** | プロット構成の技術がなく、物語創作の最初の一歩が踏み出せない |
| **すべての書く人** | 1人で行う孤独な作業に壁打ち相手がいない |

### 普通のAI（ChatGPT等）との違い

| | 普通のAIチャット | Living Tale |
|---|---|---|
| **構造** | 単一AIが全員を操作 | **キャラクターごとに独立エージェント** |
| **展開** | 予定調和 | **創発的・予測不能** |
| **ユーザーの役割** | 「指示する人」 | **「環境を与えて育てる人」** |

> **たとえ:** 普通のAI = 1人の作家に「全部書いて」と頼む / Living Tale = **役者に配役と舞台設定だけ渡して「即興劇」をさせる**

---

## 🌟 コア機能（5つ）

### 1. Dual-Layer（表と裏）システム
各キャラクターは独立AIエージェントとして動作し、**表の性格（Public Persona）** と **裏の目的（Secret Goal）** の二重構造を持つ。

### 2. 全キャラクターの内心同時表示
従来の物語では視点キャラの内心しか見えないが、Living Taleでは**全員の本音が同時に表示**される。

### 3. インタラクティブな起承転結 + AIサジェスト
起承転結の各フェーズでユーザーが方向性を指示可能。さらに**AIが「次に面白くなる展開」を3つ自動提案**し、チップUIで選べる。

### 4. 小説風の地の文生成
語り手エージェントが第三者視点で、セリフと行動・心理描写を織り交ぜた**小説として読める文体**を出力。

### 5. 4コマ漫画の自動生成
物語完成後、各フェーズの場面描写からImagen 3で**4コマ漫画を自動生成**。

---

## 🏗️ システムアーキテクチャ

### 技術スタック

| レイヤー | 技術 |
|---|---|
| **Frontend** | HTML / CSS / JavaScript（バニラ） |
| **Backend** | Python 3.11 / Flask |
| **AI Model** | Vertex AI **Gemini 2.0 Flash** (`gemini-2.0-flash-001`) |
| **画像生成** | **Imagen 3** (`imagen-3.0-generate-002`) |
| **Infra** | **Google Cloud Run**（サーバーレス） |
| **Container** | Docker |
| **Server** | Gunicorn（Workers: 1, Threads: 8） |

### アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                     ユーザー（ブラウザ）                           │
│                    Living Tale UI (HTML/JS)                      │
└──────────┬──────────────┬──────────────┬───────────────────────-─┘
           │POST /start   │POST /continue│GET /status, /suggestions
           ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Google Cloud Run                               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Flask App (Python 3.11 / Gunicorn)                       │   │
│  │                                                           │   │
│  │  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐   │   │
│  │  │  Session     │  │  Phase       │  │  Suggestion   │   │   │
│  │  │  Manager     │  │  Generator   │  │  Generator    │   │   │
│  │  │ (dict管理)   │  │ (起承転結)    │  │ (3つ自動提案) │   │   │
│  │  └─────────────┘  └──────┬───────┘  └───────────────┘   │   │
│  └──────────────────────────┼────────────────────────────────┘   │
└─────────────────────────────┼────────────────────────────────────┘
                              │ Vertex AI API
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Vertex AI                                 │
│                                                                  │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────────┐ │
│  │ Character    │ │ Narrator     │ │ Inner Thought            │ │
│  │ Agent        │ │ Agent        │ │ Agent                    │ │
│  │ (キャラ生成) │ │ (語り手)     │ │ (内心生成)               │ │
│  └──────────────┘ └──────────────┘ └──────────────────────────┘ │
│  ┌──────────────┐ ┌──────────────┐                              │
│  │ Summary      │ │ Imagen 3     │                              │
│  │ Agent        │ │ (4コマ漫画)  │                              │
│  │ (要約生成)   │ │              │                              │
│  └──────────────┘ └──────────────┘                              │
└─────────────────────────────────────────────────────────────────┘
```

### Dual-Layer Multi-Agent System の構造

```
  Layer 1: Character Agents              Layer 2: Narrative Structure
  ┌────────────────────────┐            ┌────────────────────────┐
  │  キャラクターA          │            │  起 → 承 → 転 → 結    │
  │  ├ 表: 真面目な生徒会長 │            │                        │
  │  ├ 裏: 犯人を見つけたい │            │  各フェーズで           │
  │  └ 戦略: 証拠を探す     │     ┌─────│  ユーザーが方向性指示   │
  ├────────────────────────┤     │      │  + AIが3つ自動提案     │
  │  キャラクターB          │     │      └────────────────────────┘
  │  ├ 表: 几帳面な会計     │     │
  │  ├ 裏: 使い込みを隠す   │     │      ┌────────────────────────┐
  │  └ 戦略: 疑いをそらす   │     │      │  語り手Agent           │
  └───────────┬────────────┘     │      │  第三者視点で           │
              │ 自律対話          │      │  小説風の地の文を生成   │
              ▼                  │      └────────────────────────┘
        ┌───────────┐            │
        │  会話ログ  │────────────┘
        │  + 内心    │    ユーザーの方向性指示
        └───────────┘    を各フェーズに反映
```

---

## 🔧 処理フロー

### 1. セッション開始（`POST /start`）

```
ユーザーがテーマを入力
  ↓
[Character Agent] テーマからキャラクター2名を自動生成（JSON出力）
  ├─ 名前、年齢、表の性格、裏の目的、話し方
  ↓
[Narrator Agent] 初期状況を第三者視点で描写
  ↓
[Inner Thought Agent] 各キャラの内心を個別生成
  ↓
セッションを保存、フロントエンドにキャラ情報+初期状況を返却
```

### 2. フェーズ進行（`POST /continue`）

```
ユーザーが方向性を入力（or AIサジェストから選択 or 空欄）
  ↓
[Narrator Agent] 方向性 + 直近の会話を踏まえて次の展開を描写
  ↓
[Inner Thought Agent] 各キャラの内心を個別生成
  ↓
起→承→転→結 のフェーズを自動進行
  ↓
「結」完了後、全体の要約を生成
```

### 3. AIサジェスト（`GET /suggestions/<session_id>`）

```
フェーズ遷移時にフロントエンドが自動リクエスト
  ↓
[Suggestion Agent] これまでの物語文脈を分析
  ↓
「次に加えると面白くなる展開」を3つ生成（15文字以内）
  ↓
チップUIとして表示、クリックで自動入力
  ※ フェーズごとにキャッシュ（同フェーズ再リクエスト時はAPI不要）
```

### 4. 4コマ漫画生成（非同期）

```
「結」完了後、バックグラウンドで起動
  ↓
[Gemini] 各フェーズの場面描写 → Imagen用英語プロンプトに変換
  ↓
[Imagen 3] 4枚の画像を生成（1:1, anime style）
  ↓
フロントエンドにポーリングで配信
```

---

## 📂 ファイル構成

```
living-tale/
├── README.md                          # このファイル（提出用ドキュメント）
│
├── src/                               # プロジェクトソースコード
│   ├── web_echo_interactive.py        # ★ メインアプリケーション（Flask）
│   │                                  #   - セッション管理
│   │                                  #   - キャラクター生成
│   │                                  #   - マルチエージェント会話制御
│   │                                  #   - 起承転結フェーズ管理
│   │                                  #   - AIサジェスト生成
│   │                                  #   - Imagen 3による画像生成
│   │
│   ├── web_echo_imagen_v4.py          # v4: 語り手Agent + Imagen連携版
│   ├── web_echo_fixed.py              # 初期プロトタイプ版
│   │
│   ├── templates/
│   │   └── index_interactive.html     # ★ フロントエンド（UI）
│   │                                  #   - 起承転結の進行UI
│   │                                  #   - AIサジェストチップ表示
│   │                                  #   - 内心の表示/非表示トグル
│   │                                  #   - ダークモード
│   │                                  #   - ポーリングによる非同期更新
│   │
│   ├── Dockerfile                     # Cloud Run用コンテナ定義
│   ├── requirements.txt               # Python依存: flask, google-cloud-aiplatform, gunicorn
│   └── README.md                      # 元リポジトリのREADME
│
├── articles/                          # Zenn技術記事
│   └── 435cab215d4f16.md              # Living Tale解説記事
│
└── images/                            # Zenn記事用画像
    └── living-tale-ui.png             # UIスクリーンショット
```

### 主要ファイルの役割

| ファイル | 役割 | 行数目安 |
|---|---|---|
| `src/web_echo_interactive.py` | **メインロジック**。全エンドポイント、マルチエージェント制御、セッション管理、Imagen連携を含む | ~600行 |
| `src/templates/index_interactive.html` | **フロントエンドUI**。起承転結の進行、AIサジェスト、内心表示、ポーリング処理 | ~2000行 |
| `src/web_echo_imagen_v4.py` | v4版。語り手Agent導入、第三者視点での地の文生成に特化 | ~400行 |

---

## 💡 技術的な工夫

### 1. マルチエージェント設計
- キャラクターごとに**独立したGenerativeModelインスタンス**を生成
- 各エージェントは自分の性格・目的のみを知り、他キャラの裏の目的は知らない
- → 情報の非対称性から**創発的な展開**が生まれる

### 2. レート制限対策
- Gemini API (10 RPM) に対し、**指数バックオフ** (60s→120s→180s→240s→300s) + **APIコール間8秒待機**
- `call_with_retry()` 関数で429エラーを検知し自動リトライ

### 3. 非同期処理
- 物語生成は1フェーズ数十秒かかるため、**Pythonスレッド + フロントエンドポーリング**で非同期化
- Imagen画像生成も別スレッドで並行処理

### 4. AIサジェスト
- 各フェーズ遷移時に**物語の文脈を踏まえた3つの展開提案**を自動生成
- フェーズごとにキャッシュし、APIコールを最小化

### 5. JSON出力の安定化
- プロンプトで**出力形式をJSON強制**、パース失敗時のフォールバック処理を実装

---

## 📊 コスト

| 項目 | 詳細 |
|---|---|
| Gemini 2.0 Flash | 1ストーリーあたり約10回のAPIコール |
| Imagen 3 | 4枚の画像生成 |
| Cloud Run | リクエスト時のみ起動（アイドル時 $0） |
| **1回あたりの推定コスト** | **約 $0.05〜0.10** |

---

## 📝 Zenn技術記事

詳細な技術解説は Zenn 記事にまとめています：

🔗 https://zenn.dev/zunda_official/articles/435cab215d4f16

---

## 🏆 ハッカソン審査基準への対応

| 審査基準 | 対応内容 |
|---|---|
| **課題の新規性** | マルチエージェント × Dual-Layer × 起承転結管理 による創発的物語生成は前例なし |
| **Google Cloudの活用** | Vertex AI Gemini 2.0 Flash（対話）+ Imagen 3（画像）+ Cloud Run（インフラ） |
| **解決策の有効性** | テーマ入力のみで起承転結のある物語を生成、コスト$0.05〜0.10/回 |
| **実装品質** | 堅牢なリトライ機構、非同期処理、AIサジェスト、レスポンシブUI |

---

## 👥 チーム Echo

| メンバー | 役割 |
|---|---|
| **Zenn記事**: [@zunda_official](https://zenn.dev/zunda_official) | 記事執筆・提出 |
| **開発リポ**: [@mukai-boop](https://github.com/mukai-boop/project-echo) | メイン開発 |

---

**Living Tale — 育てる。生まれる。ストーリー。**
